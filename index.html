<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Restaurante Escolar IE Baldomero Sanín Cano</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body { padding:1rem; background:#f8f9fa; }
header { text-align:center; margin-bottom:1rem; }
.qr-card { border:1px dashed #ddd; padding:0.5rem; border-radius:8px; background:#fff; }
.scanner-canvas { width:100%; height:auto; border-radius:8px; }
#registeredList .fade-in { animation: fadeIn 0.6s ease-in; }
@keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
.flash { animation: flashAnim 0.5s; }
@keyframes flashAnim { 0%{background:#ffff99;} 100%{background:transparent;} }
@media print {
  body * { visibility:hidden; }
  #print-area, #print-area * { visibility:visible; }
  #print-area { position:absolute; left:0; top:0; width:100%; }
}
</style>
</head>
<body>
<header>
<h1>Restaurante Escolar</h1>
<h3>IE Baldomero Sanín Cano</h3>
<p class="text-muted">Carga CSV • Escáner • Asistencia • Impresión • Responsive</p>
</header>

<div class="container">
  <div class="row g-3">
    <div class="col-lg-4">
      <div class="card mb-3">
        <div class="card-body">
          <h5>Importar estudiantes (CSV)</h5>
          <input id="csvFile" type="file" accept=".csv,text/csv" class="form-control mb-2" />
          <small class="text-muted">CSV: encabezados <code>name,grade</code></small>
          <button id="importBtn" class="btn btn-primary w-100 mt-2">Cargar CSV</button>
          <hr/>
          <h5>Escáner QR</h5>
          <div id="scanner-controls" class="mb-2">
            <button id="startScanner" class="btn btn-outline-primary w-100 mb-1">Iniciar escáner</button>
            <button id="stopScanner" class="btn btn-outline-secondary w-100 mb-1">Detener escáner</button>
          </div>
          <div id="scanner-area" style="display:none;">
            <video id="video" autoplay playsinline style="width:100%;border-radius:8px;"></video>
            <canvas id="canvas" style="display:none;"></canvas>
            <div class="mt-2">
              <small id="scanStatus" class="text-success"></small>
            </div>
          </div>
          <hr/>
          <h5>Estudiantes registrados hoy</h5>
          <div id="registeredList" class="list-group mb-2" style="max-height:200px; overflow:auto;"></div>
          <button id="exportPDF" class="btn btn-dark w-100">Exportar PDF</button>
        </div>
      </div>
      <div class="card">
        <div class="card-body">
          <h5>Dashboard (tiempo real)</h5>
          <p>Total estudiantes: <strong id="totalStudents">0</strong></p>
          <p>Asistencias hoy (<span id="todayDate"></span>): <strong id="attToday">0</strong></p>
          <p>Asistencias totales: <strong id="attTotal">0</strong></p>
          <button id="clearData" class="btn btn-sm btn-danger">Borrar toda la base (local)</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const STORAGE_STUDENTS = 'rs_students_v1';
const STORAGE_ATT = 'rs_attendance_v1';

function readStudents(){ return JSON.parse(localStorage.getItem(STORAGE_STUDENTS)||'[]'); }
function writeStudents(arr){ localStorage.setItem(STORAGE_STUDENTS, JSON.stringify(arr)); }
function readAttendance(){ return JSON.parse(localStorage.getItem(STORAGE_ATT)||'{}'); }
function writeAttendance(obj){ localStorage.setItem(STORAGE_ATT, JSON.stringify(obj)); }

function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,8); }
function todayKey(){ return new Date().toISOString().slice(0,10); }
function formatDateVerbose(){ 
  const d = new Date(); 
  return d.toLocaleDateString('es-CO',{weekday:'long', day:'numeric', month:'long'});
}

const totalStudentsEl = document.getElementById('totalStudents');
const attTodayEl = document.getElementById('attToday');
const attTotalEl = document.getElementById('attTotal');
document.getElementById('todayDate').textContent = formatDateVerbose();
const registeredList = document.getElementById('registeredList');

renderDashboard();

document.getElementById('importBtn').addEventListener('click', ()=>{
  const f = document.getElementById('csvFile').files[0];
  if(!f){ alert('Seleccione un CSV'); return; }
  Papa.parse(f,{header:true, skipEmptyLines:true,
    complete(results){
      const arr = readStudents();
      let added=0;
      for(const r of results.data){
        const name = (r.name||r.Nombre||r.nombre||'').trim();
        const grade = (r.grade||r.Grade||r.grado||'').trim();
        if(!name) continue;
        arr.push({id:uid(), name, grade, createdAt:new Date().toISOString()});
        added++;
      }
      writeStudents(arr);
      alert(`${added} estudiantes añadidos`);
      renderDashboard();
    }
  });
});

function renderDashboard(){
  const students = readStudents();
  const attendance = readAttendance();
  totalStudentsEl.textContent = students.length;
  const today = todayKey();
  const attToday = attendance[today]? Object.keys(attendance[today]).length:0;
  const attTotal = Object.values(attendance).reduce((s,obj)=>s+Object.keys(obj).length,0);
  attTodayEl.textContent = attToday;
  attTotalEl.textContent = attTotal;

  // actualizar listado de registrados hoy
  registeredList.innerHTML='';
  if(attendance[today]){
    const ids = Object.keys(attendance[today]);
    ids.forEach(id=>{
      const s = students.find(x=>x.id===id);
      if(s){
        const el = document.createElement('div');
        el.className='list-group-item fade-in';
        el.textContent = s.name + ' - ' + (s.grade||'');
        registeredList.appendChild(el);
      }
    });
  }
}

// ==== QR Scanner ====
let videoStream=null;
let scanning=false;
const video=document.getElementById('video');
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
const scanStatus=document.getElementById('scanStatus');
const audioRegister = new SpeechSynthesisUtterance();
audioRegister.lang='es-ES';

const audioAlready = new SpeechSynthesisUtterance();
audioAlready.lang='es-ES';

document.getElementById('startScanner').addEventListener('click', startScanner);
document.getElementById('stopScanner').addEventListener('click', stopScanner);

async function startScanner(){
  if(scanning) return;
  try{
    const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    video.srcObject=stream;
    videoStream=stream;
    document.getElementById('scanner-area').style.display='block';
    scanning=true;
    scanLoop();
  }catch(e){
    alert('No se pudo acceder a la cámara: '+e.message);
  }
}

function stopScanner(){
  scanning=false;
  if(videoStream){ videoStream.getTracks().forEach(t=>t.stop()); videoStream=null; }
  document.getElementById('scanner-area').style.display='none';
  scanStatus.textContent='';
}

let lastScanTime=0;
const SCAN_COOLDOWN_MS=1500;

function scanLoop(){
  if(!scanning) return;
  if(video.readyState===video.HAVE_ENOUGH_DATA){
    canvas.width=video.videoWidth; canvas.height=video.videoHeight;
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    const imgData=ctx.getImageData(0,0,canvas.width,canvas.height);
    const code=jsQR(imgData.data,imgData.width,imgData.height,{inversionAttempts:"attemptBoth"});
    if(code){
      const now=Date.now();
      if(now-lastScanTime>SCAN_COOLDOWN_MS){
        lastScanTime=now;
        let parsed=null;
        try{ parsed=JSON.parse(code.data);} catch(e){ parsed=null;}
        if(parsed && parsed.name){
          handleAttendance(parsed.name,parsed.grade);
        } else scanStatus.textContent='QR inválido';
      }
    } else scanStatus.textContent='Buscando QR...';
  }
  requestAnimationFrame(scanLoop);
}

function handleAttendance(name, grade){
  const students=readStudents();
  const s = students.find(x=>x.name===name && x.grade===grade);
  if(!s){ scanStatus.textContent='Estudiante no encontrado'; return; }
  const attendance=readAttendance();
  const key=todayKey();
  if(!attendance[key]) attendance[key]={};
  if(attendance[key][s.id]){
    scanStatus.textContent='Ya registrado';
    audioAlready.text=`Estudiante ${s.name} ya registrado`;
    speechSynthesis.speak(audioAlready);
    return;
  }
  attendance[key][s.id]=new Date().toISOString();
  writeAttendance(attendance);
  scanStatus.textContent=`Registrado: ${s.name}`;
  audioRegister.text=`Estudiante ${s.name} registrado`;
  speechSynthesis.speak(audioRegister);
  renderDashboard();
  // efecto flash
  const el=document.createElement('div');
  el.className='flash position-absolute top-0 start-0 w-100 h-100';
  document.body.appendChild(el);
  setTimeout(()=>{document.body.removeChild(el);},500);
}

// ==== Exportar PDF ====
document.getElementById('exportPDF').addEventListener('click', ()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const today=formatDateVerbose();
  doc.setFontSize(14);
  doc.text(`Estudiantes registrados - ${today}`,10,15);
  const students=readStudents();
  const attendance=readAttendance();
  const key=todayKey();
  if(attendance[key]){
    let y=25, i=1;
    Object.keys(attendance[key]).forEach(id=>{
      const s = students.find(x=>x.id===id);
      if(s){
        doc.text(`${i}. ${s.name} - ${s.grade}`,10,y);
        y+=7; i++;
      }
    });
  }
  doc.save(`Estudiantes_${today}.pdf`);
});

// ==== Clear local storage ====
document.getElementById('clearData').addEventListener('click',()=>{
  if(confirm('Borrar estudiantes y asistencias?')){
    localStorage.removeItem(STORAGE_STUDENTS);
    localStorage.removeItem(STORAGE_ATT);
    registeredList.innerHTML='';
    renderDashboard();
  }
});

// ==== Demo students si no hay ninguno ====
if(readStudents().length===0){
  const sample=[
    {id:uid(), name:'Carlos Pérez', grade:'10-1', createdAt:new Date().toISOString()},
    {id:uid(), name:'María Gómez', grade:'9-2', createdAt:new Date().toISOString()},
    {id:uid(), name:'Juan Rodríguez', grade:'11-3', createdAt:new Date().toISOString()},
    {id:uid(), name:'Ana Morales', grade:'10-2', createdAt:new Date().toISOString()}
  ];
  writeStudents(sample);
  renderDashboard();
}
</script>
</body>
</html>



