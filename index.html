<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Restaurante Escolar IE Baldomero Sanín Cano</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Librerías -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body { padding: 1rem; background:#f8f9fa; }
header { text-align:center; margin-bottom:1rem; }
.qr-card { border:1px dashed #ddd; padding:0.5rem; border-radius:8px; background:#fff; }
#video { width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius:8px; }

/* Print styles */
@media print {
  body * { visibility: hidden; }
  #print-area, #print-area * { visibility: visible; }
  #print-area { position: absolute; left:0; top:0; width:100%; }
  .label { page-break-inside: avoid; }
}

/* QR sheet layout: 3x4 por hoja tamaño carta */
.label {
  width: 180px;
  height: 180px;
  padding:6px;
  border:1px solid #ddd;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  margin:6px;
  background:#fff;
  page-break-inside: avoid;
}
#labelsContainer {
  display:flex;
  flex-wrap:wrap;
  justify-content:flex-start;
}

/* Flash effect */
.flash {
  animation: flashAnim 0.4s;
}
@keyframes flashAnim {
  0% { background-color: #ffff99; }
  50% { background-color: #f8f9fa; }
  100% { background-color: #f8f9fa; }
}
</style>
</head>
<body>

<header>
  <h1>Restaurante Escolar</h1>
  <h3>IE Baldomero Sanín Cano</h3>
  <p class="text-muted">Carga CSV • Códigos QR • Escáner • Asistencia • Impresión • PDF profesional • Responsive</p>
</header>

<div class="container">
  <div class="row g-3">

    <div class="col-lg-4">
      <div class="card mb-3">
        <div class="card-body">
          <h5>Importar estudiantes (CSV)</h5>
          <input id="csvFile" type="file" accept=".csv,text/csv" class="form-control mb-2" />
          <small class="text-muted">CSV: encabezados <code>name,grade</code> (name obligatorio)</small>
          <button id="importBtn" class="btn btn-primary w-100 mt-2">Cargar CSV</button>
          <hr/>
          <h5>Escáner QR</h5>
          <div id="scanner-controls" class="mb-2">
            <button id="startScanner" class="btn btn-outline-primary w-100 mb-1">Iniciar escáner</button>
            <button id="stopScanner" class="btn btn-outline-secondary w-100 mb-1">Detener escáner</button>
            <small class="text-muted">QR debe contener JSON: <code>{"name":"Juan Pérez","grade":"10-1"}</code></small>
          </div>
          <div id="scanner-area" style="display:none;">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas" style="display:none;"></canvas>
            <div class="mt-2">
              <small id="scanStatus" class="text-success"></small>
            </div>
            <div id="registeredList" class="mt-2">
              <h6>Estudiantes registrados hoy:</h6>
              <ul id="todayStudents" class="list-group list-group-flush"></ul>
            </div>
          </div>
          <hr/>
          <button id="printAll" class="btn btn-dark w-100">Imprimir todos los QRs</button>
          <button id="exportPDF" class="btn btn-outline-secondary w-100 mt-1">Exportar PDF</button>
        </div>
      </div>

      <!-- Dashboard -->
      <div class="card">
        <div class="card-body">
          <h5>Dashboard (tiempo real)</h5>
          <p>Total estudiantes: <strong id="totalStudents">0</strong></p>
          <p>Asistencias hoy (<span id="todayDate"></span>): <strong id="attToday">0</strong></p>
          <p>Asistencias totales: <strong id="attTotal">0</strong></p>
          <button id="clearData" class="btn btn-sm btn-danger">Borrar toda la base (local)</button>
        </div>
      </div>
    </div>

    <div class="col-lg-8">
      <!-- Print area hidden -->
      <div id="print-area" style="display:none; background:#fff; padding:1rem;">
        <div id="labelsContainer"></div>
      </div>
    </div>
  </div>
</div>

<script>
// STORAGE
const STORAGE_STUDENTS = 'rs_students_v1';
const STORAGE_ATT = 'rs_attendance_v1';

function readStudents(){ return JSON.parse(localStorage.getItem(STORAGE_STUDENTS) || '[]'); }
function writeStudents(arr){ localStorage.setItem(STORAGE_STUDENTS, JSON.stringify(arr)); }
function readAttendance(){ return JSON.parse(localStorage.getItem(STORAGE_ATT) || '{}'); }
function writeAttendance(obj){ localStorage.setItem(STORAGE_ATT, JSON.stringify(obj)); }

function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,8); }
function todayKey(){ return new Date().toISOString().slice(0,10); }

const totalStudentsEl = document.getElementById('totalStudents');
const attTodayEl = document.getElementById('attToday');
const attTotalEl = document.getElementById('attTotal');
document.getElementById('todayDate').textContent = todayKey();

// Import CSV
document.getElementById('importBtn').addEventListener('click', async ()=>{
  const f = document.getElementById('csvFile').files[0];
  if(!f){ alert('Seleccione CSV'); return; }
  Papa.parse(f,{header:true,skipEmptyLines:true,
    complete(results){
      const arr = readStudents();
      let added=0;
      for(const r of results.data){
        const name = (r.name||'').trim();
        const grade = (r.grade||'').trim();
        if(!name) continue;
        arr.push({id:uid(), name, grade, createdAt:new Date().toISOString()});
        added++;
      }
      writeStudents(arr);
      alert(`Importación finalizada: ${added} estudiantes añadidos.`);
    },
    error(err){ alert('Error parseando CSV: '+err.message); }
  });
});

// Attendance
function registerAttendanceQR(name, grade){
  const students = readStudents();
  const student = students.find(s=>s.name===name && s.grade===grade);
  if(!student) return 'notfound';
  const att = readAttendance();
  const key = todayKey();
  if(!att[key]) att[key]={};
  if(att[key][student.id]) return 'already';
  att[key][student.id] = new Date().toISOString();
  writeAttendance(att);
  renderDashboard();
  renderTodayList();
  return student.name;
}

// Render dashboard
function renderDashboard(){
  const students = readStudents();
  const att = readAttendance();
  const today = todayKey();
  totalStudentsEl.textContent = students.length;
  attTodayEl.textContent = att[today]?Object.keys(att[today]).length:0;
  attTotalEl.textContent = Object.values(att).reduce((s,obj)=>s+Object.keys(obj).length,0);
}
renderDashboard();

// Render registered today
function renderTodayList(){
  const att = readAttendance();
  const today = todayKey();
  const ul = document.getElementById('todayStudents');
  ul.innerHTML='';
  if(att[today]){
    const students = readStudents();
    Object.keys(att[today]).forEach((id,index)=>{
      const s = students.find(st=>st.id===id);
      if(s){
        const li = document.createElement('li');
        li.className='list-group-item flash';
        li.textContent = `${index+1}. ${s.name} - ${s.grade}`;
        ul.appendChild(li);
        setTimeout(()=>li.classList.remove('flash'),400);
      }
    });
  }
}
renderTodayList();

// QR Scanner
let videoStream=null;
let scanning=false;
const video=document.getElementById('video');
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
const scanStatus=document.getElementById('scanStatus');

document.getElementById('startScanner').addEventListener('click',startScanner);
document.getElementById('stopScanner').addEventListener('click',stopScanner);

async function startScanner(){
  if(scanning) return;
  try{
    let stream=null;
    try{ stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:{exact:"environment"}}}); }
    catch(e){ stream = await navigator.mediaDevices.getUserMedia({video:true}); }
    video.srcObject=stream;
    videoStream=stream;
    scanning=true;
    document.getElementById('scanner-area').style.display='block';
    scanLoop();
  }catch(err){ alert('No se pudo acceder a la cámara: '+err.message); }
}
function stopScanner(){
  scanning=false;
  if(videoStream){ videoStream.getTracks().forEach(t=>t.stop()); videoStream=null; }
  document.getElementById('scanner-area').style.display='none';
  scanStatus.textContent='';
}

// Mantener el video cuadrado
video.addEventListener('loadedmetadata',()=>{
  video.style.height = video.offsetWidth + 'px';
});

let lastScan=0;
function scanLoop(){
  if(!scanning) return;
  if(video.readyState===video.HAVE_ENOUGH_DATA){
    canvas.width=video.videoWidth;
    canvas.height=video.videoHeight;
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    const imgData=ctx.getImageData(0,0,canvas.width,canvas.height);
    const code=jsQR(imgData.data,imgData.width,imgData.height,{inversionAttempts:"attemptBoth"});
    if(code){
      const now=Date.now();
      if(now-lastScan>1500){
        lastScan=now;
        let parsed=null;
        try{ parsed=JSON.parse(code.data); }catch(e){ parsed=null; }
        if(parsed && parsed.name && parsed.grade){
          const res=registerAttendanceQR(parsed.name, parsed.grade);
          if(res==='notfound'){ scanStatus.textContent='Estudiante no encontrado'; speak('Estudiante no encontrado'); }
          else if(res==='already'){ scanStatus.textContent='Ya registrado'; speak('Estudiante ya registrado'); }
          else{ scanStatus.textContent=`Registrado: ${res}`; speak(`Estudiante registrado: ${res}`); }
        } else { scanStatus.textContent='QR inválido'; speak('QR inválido'); }
      }
    } else { scanStatus.textContent='Buscando QR...'; }
  }
  requestAnimationFrame(scanLoop);
}

// Speech
function speak(text){ const u = new SpeechSynthesisUtterance(text); window.speechSynthesis.speak(u); }

// Print all QRs
function buildPrintLabels(){
  const container=document.getElementById('labelsContainer');
  container.innerHTML='';
  const students=readStudents();
  for(const s of students){
    const label=document.createElement('div'); label.className='label';
    const holder=document.createElement('div'); label.appendChild(holder);
    const nameEl=document.createElement('div'); nameEl.style='font-size:12px; margin-top:6px; text-align:center;';
    nameEl.textContent=`${s.name} - ${s.grade}`;
    label.appendChild(nameEl);
    container.appendChild(label);
    const payload=JSON.stringify({name:s.name, grade:s.grade});
    new QRCode(holder,{text:payload,width:140,height:140});
  }
}

document.getElementById('printAll').addEventListener('click',()=>{
  buildPrintLabels();
  document.getElementById('print-area').style.display='block';
  setTimeout(()=>{ window.print(); document.getElementById('print-area').style.display='none'; },500);
});

// Export PDF profesional
document.getElementById('exportPDF').addEventListener('click',()=>{
  const att=readAttendance();
  const today=todayKey();
  if(!att[today]){ alert('No hay registros hoy'); return; }
  const students=readStudents();
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(16);
  doc.setTextColor(40,40,40);
  doc.setDrawColor(0);
  doc.setLineWidth(0.5);

  // Encabezado profesional
  doc.setFillColor(200, 220, 255);
  doc.rect(10,10,190,12,'F');
  doc.text(`Estudiantes registrados - ${formatDateToday()}`,105,19,{align:'center'});

  // Tabla
  const startY = 28;
  const rowHeight = 10;
  const colX = [14, 24, 120]; // Número, Nombre, Grado
  doc.setFontSize(12);
  doc.setTextColor(0);
  doc.text('N°', colX[0], startY);
  doc.text('Nombre', colX[1], startY);
  doc.text('Grado', colX[2], startY);
  let y = startY + rowHeight;
  let index =1;

  Object.keys(att[today]).forEach(id=>{
    const s=students.find(st=>st.id===id);
    if(s){
      if(y>280){ doc.addPage(); y=28; doc.text('N°', colX[0], y); doc.text('Nombre', colX[1], y); doc.text('Grado', colX[2], y); y+=rowHeight;}
      doc.rect(10, y-8, 190, rowHeight); // fila con borde
      doc.text(`${index}`, colX[0], y);
      doc.text(`${s.name}`, colX[1], y);
      doc.text(`${s.grade}`, colX[2], y);
      y+=rowHeight;
      index++;
    }
  });

  doc.save(`Estudiantes_${today}.pdf`);
});

function formatDateToday(){
  const d=new Date();
  const opts={weekday:'long',day:'numeric',month:'long'};
  return d.toLocaleDateString('es-ES',opts);
}

// Clear data
document.getElementById('clearData').addEventListener('click',()=>{
  if(confirm('Borrar estudiantes y asistencias?')){
    localStorage.removeItem(STORAGE_STUDENTS);
    localStorage.removeItem(STORAGE_ATT);
    renderDashboard();
    renderTodayList();
  }
});

// Demo students
if(readStudents().length===0){
  const sample=[
    {id:uid(), name:'Carlos Pérez', grade:'10-1', createdAt:new Date().toISOString()},
    {id:uid(), name:'María Gómez', grade:'9-2', createdAt:new Date().toISOString()},
    {id:uid(), name:'Juan Rodríguez', grade:'11-3', createdAt:new Date().toISOString()},
    {id:uid(), name:'Ana Morales', grade:'10-2', createdAt:new Date().toISOString()}
  ];
  writeStudents(sample);
}
</script>
</body>
</html>
